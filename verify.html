<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ECOTrack | Teacher Verification â€” EcoLux</title>
  <style>
    *{box-sizing:border-box;font-family:Inter, Poppins, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    :root{
      --bg: linear-gradient(135deg,#05220f 0%, #0b3a23 40%, #052b14 100%);
      --card: rgba(255,255,255,0.06);
      --glass-blur:12px;
      --accent-emerald:#00b37e; --accent-neon:#b9ff00; --accent-gold:#caa038;
      --muted:rgba(255,255,255,0.88);
      --radius:14px;
    }
    body{min-height:100vh;margin:0;padding:28px;background:var(--bg);color:var(--muted);-webkit-font-smoothing:antialiased}
    .container{max-width:1100px;margin:0 auto}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:56px;height:56px;border-radius:12px;display:grid;place-items:center;font-size:28px;background:linear-gradient(135deg,var(--accent-emerald),var(--accent-neon));color:#05220f}
    h1{font-size:20px}
    .controls{display:flex;gap:12px;align-items:center}
    .teacherInfo{font-weight:700;color:rgba(255,255,255,0.95)}
    .search input{padding:12px;border-radius:12px;border:none;background:rgba(255,255,255,0.06);color:var(--muted);min-width:220px}

    .panel{background:var(--card);backdrop-filter:blur(var(--glass-blur));border-radius:var(--radius);padding:16px;box-shadow:0 12px 36px rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.04)}
    .student-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-top:16px}

    .student-card{border-radius:12px;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:8px}
    .student-card.verified{background:linear-gradient(90deg, rgba(0,179,126,0.12), rgba(255,255,255,0.02));border:1px solid rgba(0,179,126,0.14)}
    .student-name{font-weight:700}
    .meta{font-size:13px;color:rgba(255,255,255,0.8)}

    .card-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .card-actions{display:flex;gap:8px}
    .btn{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
    .btn-verify{background:linear-gradient(90deg,var(--accent-emerald),var(--accent-neon));color:#05220f}
    .btn-reject{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--muted)}

    .hint{margin-top:12px;font-weight:600;color:rgba(255,255,255,0.85)}
    .logout{margin-top:14px;padding:10px 14px;border-radius:10px;background:linear-gradient(90deg,#a63a2b,var(--accent-gold));border:none;color:#06160d;font-weight:800}

    @media (max-width:720px){
      .top{flex-direction:column;align-items:flex-start}
      .search input{width:100%}
      .student-list{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top">
      <div class="brand">
        <div class="logo">ðŸŒ±</div>
        <div>
          <h1>Teacher Verification</h1>
          <div class="subtitle">Approve students for your assigned grade & section</div>
        </div>
      </div>

      <div class="controls">
        <div id="teacherInfo" class="teacherInfo">Loading your grade & sectionâ€¦</div>
        <div class="search"><input id="searchInput" type="text" placeholder="Search students by name or email (optional)" /></div>
      </div>
    </div>

    <div class="panel">
      <div id="studentList" class="student-list" aria-live="polite">Loading studentsâ€¦</div>

      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
        <button id="logoutBtn" class="logout">Log Out</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, query, where, getDocs, doc, getDoc, setDoc, updateDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
  apiKey: "AIzaSyAvblGiAIZ26bIbtw6cSv9kfgzSiYyq_10",
  authDomain: "registar-5f3fb.firebaseapp.com",
  projectId: "registar-5f3fb",
  storageBucket: "registar-5f3fb.firebasestorage.app",
  messagingSenderId: "856198150739",
  appId: "1:856198150739:web:801000f564b47f6333e4a6"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const studentList = document.getElementById('studentList');
    const searchInput = document.getElementById('searchInput');
    const teacherInfo = document.getElementById('teacherInfo');
    const logoutBtn = document.getElementById('logoutBtn');

    let teacherGrade = ""; let teacherSection = ""; let pendingStudents = []; let currentUser = null;

    onAuthStateChanged(auth, async (user)=>{
      if (!user){ window.location.href='index.html'; return; }
      currentUser = user;
      try{
        const tdoc = await getDoc(doc(db,'teachers',user.uid));
        if (!tdoc.exists()){ alert('Teacher account not found or not approved. Contact admin.'); await signOut(auth); window.location.href='index.html'; return; }
        const t = tdoc.data(); if (!t.verified && t.verified !== true){ alert('Your account is not approved by admin yet.'); await signOut(auth); window.location.href='index.html'; return; }
        teacherGrade = String(t.grade||'').trim(); teacherSection = String(t.section||'').trim(); teacherInfo.innerText = `Assigned: ${teacherGrade} â€¢ ${teacherSection}`;
        await loadPendingStudents();
      }catch(err){ console.error('Error loading teacher data:',err); alert('Error loading data â€” check console.'); await signOut(auth); window.location.href='index.html'; }
    });

    async function loadPendingStudents(){
      studentList.innerHTML = `<p style="text-align:center">Loadingâ€¦</p>`;
      try{
        const q = query(collection(db,'verificationRequests'), where('status','==','pending'));
        const snap = await getDocs(q); pendingStudents = [];
        snap.forEach(s=> pendingStudents.push({ id: s.id, ...s.data() }));

        const normalize = g=> String(g||'').toLowerCase().replace(/\s+/g,'');
        const tg = normalize(teacherGrade); const ts = String(teacherSection||'').toLowerCase().trim();

        pendingStudents = pendingStudents.filter(s=>{ const sg = normalize(s.grade); const ss = String(s.section||'').toLowerCase().trim(); return sg===tg && ss===ts; });
        renderStudents(pendingStudents);
      }catch(err){ console.error('Failed to load pending students:',err); studentList.innerHTML = `<p style="text-align:center">Failed to load students. Check console.</p>`; }
    }

    function renderStudents(list){
      const term = (searchInput.value||'').trim().toLowerCase();
      const filtered = list.filter(s=>{ if (!term) return true; const name = (s.firstName||s.name||'') + ' ' + (s.lastName||''); return name.toLowerCase().includes(term) || (s.email||'').toLowerCase().includes(term); });
      if (filtered.length===0){ studentList.innerHTML = `<p style="text-align:center">No pending requests for ${teacherGrade} â€¢ ${teacherSection}.</p>`; return; }
      studentList.innerHTML = '';
      filtered.forEach(s=>{
        const div = document.createElement('div'); div.className = 'student-card';
        div.innerHTML = `
          <div>
            <div class="student-name">${escapeHtml((s.firstName||s.name)||'Unnamed')} ${escapeHtml(s.middleInitial||'')} ${escapeHtml(s.lastName||'')}</div>
            <div class="meta">Grade: ${escapeHtml(s.grade||'')} ${s.age? 'â€¢ Age: '+escapeHtml(s.age): ''} â€¢ Section: ${escapeHtml(s.section||'')}</div>
            <div class="meta">${escapeHtml(s.email||'')}</div>
          </div>
          <div class="card-row">
            <div class="card-actions">
              <button class="btn btn-verify" data-req="${escapeHtml(s.id)}" data-id="${escapeHtml(s.studentId||s.id)}">Verify</button>
              <button class="btn btn-reject" data-req="${escapeHtml(s.id)}">Reject</button>
            </div>
          </div>
        `;
        studentList.appendChild(div);
      });
      attachButtons();
    }

    function attachButtons(){
      document.querySelectorAll('.btn-verify').forEach(btn=>{
        btn.onclick = async ()=>{
          const reqId = btn.dataset.req; const studentId = btn.dataset.id; btn.disabled = true;
          try{
            const reqRef = doc(db,'verificationRequests',reqId); const reqSnap = await getDoc(reqRef); if (!reqSnap.exists()){ alert('Request missing.'); return; }
            const data = reqSnap.data();
            await setDoc(doc(db,'students',studentId),{
              studentId, firstName: data.firstName||data.name||'', middleInitial: data.middleInitial||'', lastName: data.lastName||'', email: data.email||'', grade: data.grade||'', section: data.section||'', age: data.age||null, verified:true, verifiedBy: currentUser.uid, verifiedAt: serverTimestamp(), createdAt: data.requestedAt || serverTimestamp()
            });
            await updateDoc(reqRef,{status:'approved', reviewedAt: serverTimestamp(), reviewedBy: currentUser.uid});
            await loadPendingStudents();
          }catch(err){ console.error('Verify failed:',err); alert('Failed to verify: '+(err.message||err)); btn.disabled = false; }
        }
      });

      document.querySelectorAll('.btn-reject').forEach(btn=>{
        btn.onclick = async ()=>{
          const reqId = btn.dataset.req; if (!confirm('Reject this verification request?')) return;
          try{ await updateDoc(doc(db,'verificationRequests',reqId),{status:'rejected', reviewedAt: serverTimestamp(), reviewedBy: currentUser.uid}); await loadPendingStudents(); }catch(err){ console.error('Reject failed:',err); alert('Failed to reject: '+(err.message||err)); }
        }
      });
    }

    searchInput.addEventListener('input', ()=> renderStudents(pendingStudents));
    logoutBtn.addEventListener('click', async ()=>{ await signOut(auth); window.location.href='index.html'; });

    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
  </script>
</body>
</html>

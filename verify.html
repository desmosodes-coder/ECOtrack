<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Teacher Verification</title>

  <style>
    * { font-family: Poppins; box-sizing: border-box; }
    body { background:linear-gradient(135deg,#9be15d,#00e3ae); padding:20px; }
    h1 { text-align:center; color:#2e7d32; }
    .list { max-width:700px; margin:auto; background:white; padding:20px; border-radius:15px; }
    .card { background:#e8f5e9; padding:15px; border-radius:10px; margin-bottom:10px; display:flex; justify-content:space-between; }
    .verified { background:#81c784 !important; color:white; }
    button { background:#2e7d32; color:white; border:none; padding:8px 12px; border-radius:8px; }
    button:hover { background:#1b5e20; }
    .logout { margin-top:20px; display:block; width:120px; margin:auto; }
  </style>
</head>
<body>

<h1>Teacher — Verify Students</h1>
<div class="list" id="list">Loading students...</div>
<button class="logout" id="logout">Log Out</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, getDocs, updateDoc, doc, getDoc } 
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAvblGiAIZ26bIbtw6cSv9kfgzSiYyq_10",
    authDomain: "registar-5f3fb.firebaseapp.com",
    projectId: "registar-5f3fb",
    storageBucket: "registar-5f3fb.firebasestorage.app",
    messagingSenderId: "856198150739",
    appId: "1:856198150739:web:801000f564b47f6333e4a6"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth();
  const db = getFirestore();

  let TEACHER = null;

  onAuthStateChanged(auth, async (user) => {
    if (!user) return window.location="index.html";

    const tSnap = await getDoc(doc(db, "teachers", user.uid));

    if (!tSnap.exists() || !tSnap.data().verified) {
      alert("You are NOT a verified teacher.");
      return window.location="index.html";
    }

    TEACHER = tSnap.data();
    loadStudents();
  });

  async function loadStudents() {
    const q = await getDocs(collection(db, "students"));
    const list = document.getElementById("list");
    list.innerHTML = "";

    q.forEach(s => {
      let d = s.data();

      // filter students by matching grade + section
      if (d.grade == TEACHER.grade && d.section.toLowerCase() == TEACHER.section.toLowerCase()) {
        const div = document.createElement("div");
        div.className = "card" + (d.verified ? " verified" : "");

        div.innerHTML = `
          <div>
            <b>${d.name}</b><br>
            Grade ${d.grade} – ${d.section}<br>
            ${d.email}
          </div>
          <button ${d.verified ? "disabled" : ""} data-id="${s.id}">
            ${d.verified ? "Verified" : "Verify"}
          </button>
        `;

        list.appendChild(div);
      }
    });

    document.querySelectorAll("button[data-id]").forEach(btn => {
      btn.onclick = async () => {
        await updateDoc(doc(db, "students", btn.dataset.id), { verified:true });
        btn.innerText = "Verified";
        btn.disabled = true;
        btn.parentElement.classList.add("verified");
      };
    });
  }

  document.getElementById("logout").onclick = () => {
    signOut(auth);
    window.location="index.html";
  };
</script>

</body>
</html>

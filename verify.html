<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ECOTrack | Teacher Verification</title>
  <style>
    * { box-sizing: border-box; font-family: "Poppins", sans-serif; }
    body {
      margin: 0;
      background: linear-gradient(135deg,#9be15d,#00e3ae);
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:20px;
    }
    h1 { margin-top:20px;color:#2e7d32;text-align:center; }
    .controls { width:90%; max-width:900px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:16px; }
    select, input[type="text"] { padding:10px; border-radius:8px; border:1px solid #ccc; font-size:16px; background:white; }
    .student-list {
      width:90%; max-width:900px; background:#fff; border-radius:12px; padding:18px; margin-top:18px;
      box-shadow:0 8px 18px rgba(0,0,0,0.12); max-height:70vh; overflow:auto;
    }
    .student-card {
      display:flex; align-items:center; justify-content:space-between; padding:12px; margin:8px 0; border-radius:10px;
      background:#e8f5e9; transition:all .15s;
    }
    .student-card.verified { background:#81c784; color:#fff; }
    .student-card:hover { transform:translateY(-3px); }
    .student-info { flex:1; text-align:left; }
    .student-stats { margin-right:12px; text-align:right; color:#2e7d32; min-width:110px; }
    button.verify-btn { background:#2e7d32; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    button.verify-btn[disabled] { opacity:.7; cursor:default; }
    .hint { width:90%; max-width:900px; color:#2e7d32; margin-top:12px; font-weight:600; }
    .logout { margin-top:18px; background:#f44336; color:#fff; border:none; padding:10px 18px; border-radius:8px; cursor:pointer; }
    @media(max-width:520px){ .controls { flex-direction:column; } .student-stats { display:none; } }
  </style>
</head>
<body>
  <div class="eco-icon" style="font-size:48px">ðŸŒ¿</div>
  <h1>Teacher Verification Panel</h1>

  <div class="controls">
    <select id="gradeSelect" aria-label="Select grade">
      <option value="">-- Select Grade (Required) --</option>
      <option value="Grade 1">Grade 1</option>
      <option value="Grade 2">Grade 2</option>
      <option value="Grade 3">Grade 3</option>
      <option value="Grade 4">Grade 4</option>
      <option value="Grade 5">Grade 5</option>
      <option value="Grade 6">Grade 6</option>
    </select>

    <input id="searchInput" type="text" placeholder="Search students by name or email" disabled />
  </div>

  <div id="gradeHint" class="hint">Please select a grade to view students for that grade.</div>

  <div id="studentList" class="student-list" aria-live="polite" style="display:none">Loading studentsâ€¦</div>

  <button id="logoutBtn" class="logout">Log Out</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAvblGiAIZ26bIbtw6cSv9kfgzSiYyq_10",
      authDomain: "registar-5f3fb.firebaseapp.com",
      projectId: "registar-5f3fb",
      storageBucket: "registar-5f3fb.firebasestorage.app",
      messagingSenderId: "856198150739",
      appId: "1:856198150739:web:801000f564b47f6333e4a6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const studentList = document.getElementById("studentList");
    const searchInput = document.getElementById("searchInput");
    const gradeSelect = document.getElementById("gradeSelect");
    const gradeHint = document.getElementById("gradeHint");
    const logoutBtn = document.getElementById("logoutBtn");

    let allStudents = [];
    let currentUser = null;
    let selectedGrade = "";

    onAuthStateChanged(auth, async (user) => {
      if (!user) { window.location.href = "index.html"; return; }
      currentUser = user;

      try {
        const teacherDoc = await getDoc(doc(db, "teachers", user.uid));
        if (!teacherDoc.exists()) {
          alert("Access denied. Only teachers can view this page.");
          await signOut(auth);
          window.location.href = "index.html";
          return;
        }
      } catch (err) {
        console.error("Error checking teacher role:", err);
        alert("Error checking credentials. Check console.");
        await signOut(auth);
        window.location.href = "index.html";
        return;
      }

      await fetchStudents();
    });

    async function fetchStudents() {
      try {
        const snap = await getDocs(collection(db, "students"));
        allStudents = [];
        snap.forEach(docSnap => {
          allStudents.push({ id: docSnap.id, ...docSnap.data() });
        });
        studentList.style.display = "none";
        gradeHint.style.display = "block";
        searchInput.disabled = true;
      } catch (err) {
        console.error("Failed to fetch students:", err);
        studentList.style.display = "block";
        studentList.innerHTML = "<p>Failed to load students. Check console.</p>";
      }
    }

    gradeSelect.addEventListener("change", () => {
      selectedGrade = gradeSelect.value;
      searchInput.value = "";
      if (!selectedGrade) {
        studentList.style.display = "none";
        gradeHint.style.display = "block";
        searchInput.disabled = true;
        return;
      }
      gradeHint.style.display = "none";
      searchInput.disabled = false;
      renderStudentList(filterByGradeAndSearch(selectedGrade, ""));
      studentList.style.display = "block";
    });

    searchInput.addEventListener("input", (e) => {
      if (!selectedGrade) return;
      renderStudentList(filterByGradeAndSearch(selectedGrade, e.target.value));
    });

    function filterByGradeAndSearch(grade, searchTerm) {
      const term = (searchTerm || "").trim().toLowerCase();
      return allStudents.filter(s => {
        const matchesGrade = String(s.grade || "").toLowerCase() === String(grade || "").toLowerCase();
        if (!matchesGrade) return false;
        if (!term) return true;
        const name = (s.name || "").toLowerCase();
        const email = (s.email || "").toLowerCase();
        return name.includes(term) || email.includes(term);
      });
    }

    function renderStudentList(students) {
      studentList.innerHTML = "";
      if (!students || students.length === 0) {
        studentList.innerHTML = `<p>No students found for ${escapeHtml(selectedGrade || "selected grade")}.</p>`;
        return;
      }

      students.forEach(student => {
        const div = document.createElement("div");
        div.className = "student-card" + (student.verified ? " verified" : "");
        const minutes = (student.totalTimeSpent && Number.isFinite(student.totalTimeSpent)) ? Math.floor(student.totalTimeSpent/60) : 0;
        const seconds = (student.totalTimeSpent && Number.isFinite(student.totalTimeSpent)) ? (student.totalTimeSpent % 60) : 0;
        const timeDisplay = (student.totalTimeSpent) ? `${minutes}m ${seconds}s` : "No activity";

        div.innerHTML = `
          <div class="student-info">
            <strong>${escapeHtml(student.name || "Unnamed")}</strong><br>
            Grade: ${escapeHtml(student.grade || "")} ${student.age ? "| Age: " + escapeHtml(student.age) : ""}<br>
            <small>${escapeHtml(student.email || "")}</small>
          </div>

          <div class="student-stats">
            <div>Time Spent:</div>
            <div class="time-display">${escapeHtml(timeDisplay)}</div>
          </div>

          <div>
            <button class="verify-btn" data-id="${escapeHtml(student.id)}" ${student.verified ? "disabled" : ""}>
              ${student.verified ? "Verified" : "Verify"}
            </button>
          </div>
        `;
        studentList.appendChild(div);
      });

      attachVerifyButtons();
    }

    function attachVerifyButtons() {
      document.querySelectorAll(".verify-btn").forEach(btn => {
        btn.onclick = null;
        btn.addEventListener("click", async function onVerify() {
          const id = btn.dataset.id;
          if (!id) return;
          btn.disabled = true;
          try {
            await updateDoc(doc(db, "students", id), {
              verified: true,
              verifiedBy: currentUser ? currentUser.uid : null,
              verifiedAt: serverTimestamp()
            });

            btn.innerText = "Verified";
            const card = btn.closest(".student-card");
            if (card) card.classList.add("verified");

            const idx = allStudents.findIndex(s => s.id === id);
            if (idx !== -1) allStudents[idx].verified = true;

          } catch (err) {
            console.error("Verify failed:", err);
            alert("Verification failed. Open console for details.");
            btn.disabled = false;
          }
        }, { once: false });
      });
    }

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });

    function escapeHtml(s) {
      return String(s || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }
  </script>
</body>
</html>